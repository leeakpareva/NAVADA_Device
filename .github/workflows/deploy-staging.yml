name: Deploy Staging to Testing Repository

on:
  push:
    branches: [ staging ]
  pull_request:
    branches: [ staging ]

jobs:
  deploy-to-testing:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout staging branch
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'

    - name: Install dependencies
      run: npm ci

    - name: Build project for static export
      run: npm run build
      env:
        ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        NODE_ENV: production
        DEPLOY_TARGET: static

    - name: Run tests (if any)
      run: npm test --if-present

    - name: Deploy to Testing Repository
      uses: peaceiris/actions-gh-pages@v3
      with:
        personal_token: ${{ secrets.TESTING_REPO_TOKEN }}
        external_repository: leeakpareva/NAVADA_Device_Testing
        publish_branch: main
        publish_dir: ./out
        cname: navada-testing.vercel.app

    - name: Create deployment summary
      run: |
        echo "## üöÄ Staging Deployment Summary" >> $GITHUB_STEP_SUMMARY
        echo "- **Source Branch**: staging" >> $GITHUB_STEP_SUMMARY
        echo "- **Target Repository**: NAVADA_Device_Testing" >> $GITHUB_STEP_SUMMARY
        echo "- **Deployment Time**: $(date)" >> $GITHUB_STEP_SUMMARY
        echo "- **Commit**: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Testing URL**: https://navada-testing.vercel.app" >> $GITHUB_STEP_SUMMARY

  notify-deployment:
    needs: deploy-to-testing
    runs-on: ubuntu-latest
    if: always()
    steps:
    - name: Notify Success
      if: needs.deploy-to-testing.result == 'success'
      run: |
        echo "‚úÖ Staging successfully deployed to testing environment"
        echo "üîó Testing URL: https://navada-testing.vercel.app"

    - name: Notify Failure
      if: needs.deploy-to-testing.result == 'failure'
      run: |
        echo "‚ùå Staging deployment failed"
        echo "Check the logs for more information"